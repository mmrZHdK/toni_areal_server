$(document).ready(function(){function e(e,t){var n;return 0!=e.events[t].enddatum?($("#agendaTile"+t).addClass("eventOverTime"),n=moment(1e3*e.events[t].startdatum).format("Do MMM YYYY")+" - "+moment(1e3*e.events[t].enddatum).format("Do MMM YYYY")):n=0!=e.events[t].endzeit?moment(1e3*e.events[t].startzeit).format("HH:mm")+" - "+moment(1e3*e.events[t].endzeit).format("HH:mm")+" Uhr":moment(1e3*e.events[t].startzeit).format("HH:mm")+" Uhr",n}function t(e,t){var n;return 0!=e.events[t].enddatum?($("#agendaTile"+t).addClass("eventOverTime"),n=moment(1e3*e.events[t].startdatum).format("Do MMM YYYY")+" - "+moment(1e3*e.events[t].enddatum).format("Do MMM YYYY")):n=0!=e.events[t].endzeit?moment(1e3*e.events[t].startdatum).format("Do MMM YYYY")+", "+moment(1e3*e.events[t].startzeit).format("HH:mm")+" - "+moment(1e3*e.events[t].endzeit).format("HH:mm")+" Uhr":moment(1e3*e.events[t].startdatum).format("Do MMM YYYY")+", "+moment(1e3*e.events[t].startzeit).format("HH:mm")+" Uhr",n}var n=$(".swiper-container").swiper({mode:"horizontal",loop:!1}),o=document.getElementById("body"),a=getEmPixels(o),i=getEmPixels(),d=(o.clientWidth/a,o.clientWidth/i,new Date(moment().valueOf())),l=moment(),r=moment().add(1,"d"),m=($("#pagesWrapper"),$("#mensa")),s=$("#menu"),c=$(window).width(),g=0,p=0,u=0,h=0;Date.prototype.getWeek=function(){var e=new Date(this.getFullYear(),0,1);return Math.ceil(((this-e)/864e5+e.getDay()+1)/7)},moment.locale("de");n.wrapperTransitionEnd(function(){0===n.activeIndex?menuChar="mensa":1===n.activeIndex?menuChar="agenda":2===n.activeIndex&&(menuChar="tram"),$("#menu").html(menuChar)},!0),$("#mensaLoadingImg").velocity({rotateZ:"360deg"},{loop:!0});var v=0,f=function(){$.get("http://www.corsproxy.com/zfv.ch/de/microsites/gastronomie-im-toni-areal/menueplan",function(e){var t=$(e);$("#mensaLoading img").velocity("stop"),$("#mensaLoading").toggle(!1),6==d.getDay()&&(d=new Date(moment().valueOf()+1728e5)),0==d.getDay()&&(d=new Date(moment().valueOf()+864e5)),Y(t,d)}).fail(function(){5>v?(v++,f()):($("#mensaLoading img").velocity("stop"),$("#mensaLoading").toggle(!1),$("<div>",{"class":"mensaTileDate roboto",html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#mensa"))})};f();var Y=function(e,t){var n=t.getWeek(),o=t.getDay(),i=-5*a;$("#mensa div").each(function(){i=i+$(this).height()+1.44*a}),$("<div>",{id:"mensaTileDate"+o,"class":"mensaTileDate roboto",html:moment(t).format("dddd, Do MMM YYYY")}).appendTo("#mensa"),moment(t).format("YYYY-MM-D")==l.format("YYYY-MM-D")&&$("#mensaTileDate"+o).html(moment(t).format("[Heute,] Do MMM YYYY")),moment(t).format("YYYY-MM-D")==r.format("YYYY-MM-D")&&$("#mensaTileDate"+o).html(moment(t).format("[Morgen,] Do MMM YYYY")),e.find("tbody tr").each(function(e){if($(this).data("dayofweek")==o&&$(this).data("weeknumber")==n){var t=$(this).find(":nth-child(1)"),a=$(this).find(":nth-child(2)");$("<div>",{id:"mensaTile"+e,"class":"mensaTile"}).appendTo("#mensa"),$("<span>",{html:t}).appendTo("#mensaTile"+e),$("<p>",{html:a}).appendTo("#mensaTile"+e),$("#mensaMenu").toggle(!0),$("#mensaMenu tr").toggle(!0),$("#mensaTile"+e+" p br:last-child").remove()}}),5!=t.getDay()&&$("<div>",{id:"mensaTileDate"+o+1,"class":"mensaTile next",html:"nÃ¤chster Tag"}).appendTo("#mensa"),m.animate({scrollTop:i},600),g=0,$(".mensaTile").each(function(){$(this).is(":visible")||(g++,$(this).delay(100*g).velocity("transition.flipYIn",200))}),$("#mensaTileDate"+o+1).click(function(){$("#mensaTileDate"+o+1).remove(),Y(e,new Date(moment(t).valueOf()+864e5))})};$("#agendaLoadingImg").velocity({rotateZ:"360deg"},{loop:!0});var T=moment(l).format("YYYY-MM-D"),M=moment(l).add(4,"M").format("YYYY-MM-D"),y=0,D=function(){$.getJSON("http://www.zhdk.ch/?agenda/feed&mindate="+T+"&maxdate="+M+"&format=json",null,function(e){L(e,0,24),$("#agendaLoading img").velocity("stop"),$("#agendaLoading").toggle(!1)}).fail(function(){5>y?(y++,D()):($("#agendaLoading img").velocity("stop"),$("#agendaLoading").toggle(!1),$("<div>",{"class":"agendaTileDate roboto",html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#agenda"))})};D();var L=function(n,o,a){for(indexLoad=o;a>=indexLoad;++indexLoad){var i=e(n,indexLoad);u=1e3*n.events[indexLoad].startdatum;var d=new Date(u);u!=h&&0==n.events[indexLoad].enddatum&&($("<div>",{id:"agendaTileDate"+u,"class":"agendaTile agendaTileDate roboto",html:moment(d).format("dddd, Do MMM YYYY")}).appendTo("#agenda"),moment(d).format("YYYY-MM-D")==l.format("YYYY-MM-D")&&$("#agendaTileDate"+u).html(moment(d).format("[Heute,] Do MMM YYYY")),moment(d).format("YYYY-MM-D")==r.format("YYYY-MM-D")&&$("#agendaTileDate"+u).html(moment(d).format("[Morgen,] Do MMM YYYY"))),h=u,$("<div>",{id:"agendaTile"+indexLoad,"class":"agendaTile"}).appendTo("#agenda").click(function(e){$("#popupEvent").toggleClass("popup"),$("#popupBg").velocity("fadeIn",{duration:400});var o=e.currentTarget.id.replace("agendaTile","");if($("<span>",{html:n.events[o].titel}).appendTo("#eventContainer"),$("<span>",{html:t(n,o)}).appendTo("#eventContainer"),$("<span>",{html:"Veranstaltungsort: "+n.events[o].loc_shortname}).appendTo("#eventContainer"),$("<p>",{html:n.events[o].beschreibung}).appendTo("#eventContainer"),$("#popupEvent").css("background-image","none"),void 0!=n.events[o].files_info_img&&void 0!=n.events[o].files_info_img[0].thumb_ext_url){var a=n.events[o].files_info_img[0].thumb_ext_url;$("#popupEvent").css({"background-image":"url("+a+")","background-size":"auto "+2*c});var i=n.events[o].files_info_img[0].img_ext_url;$("<img>",{id:"eventImgLoader"}).appendTo("#eventContainer"),$("#eventImgLoader").queue(function(){$(this).delay(400)}).attr("src",i).load(function(){$(this).remove(),$("#popupEvent").css("background-image","url("+i+")")})}}),i=e(n,indexLoad),$("<span>",{html:n.events[indexLoad].titel}).appendTo("#agendaTile"+indexLoad),$("<p>",{html:n.events[indexLoad].kurzbeschreibung}).appendTo("#agendaTile"+indexLoad),$("<span>",{html:i,"class":"eventDateAndTime"}).appendTo("#agendaTile"+indexLoad)}$("<div>",{"class":"agendaTileLoadMore agendaTile",html:"Lade weitere"}).appendTo("#agenda").click(function(){L(n,a+1,a+25),$(".agendaTileLoadMore").toggle(!1)}),p=0,$(".agendaTile").each(function(){$(this).is(":visible")||$(this).hasClass("eventOverTime")||(p++,$(this).delay(100*p).velocity("transition.flipYIn",200))})};$("#tramLoadingImg0").velocity({rotateZ:"360deg"},{loop:!0}),$("#tramLoadingImg1").velocity({rotateZ:"360deg"},{loop:!0}),$("#tramLoadingImg2").velocity({rotateZ:"360deg"},{loop:!0}),$("#tramLoadingImg3").velocity({rotateZ:"360deg"},{loop:!0});var b=0,w=function(){$.get("http://transport.opendata.ch/v1/connections?from=008591398&to=008503001",function(e){E($(e)),$("#tramLoading0 img").velocity("stop"),$("#tramLoading0").toggle(!1)}).fail(function(){5>b?(b++,w()):($("#tramLoading0 img").velocity("stop"),$("#tramLoading0").toggle(!1),$("<p>",{html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#toAltstettenTile"))})};w();var k=0,x=function(){$.get("http://transport.opendata.ch/v1/connections?from=008591398&to=008576182",function(e){W($(e)),$("#tramLoading1 img").velocity("stop"),$("#tramLoading1").toggle(!1)}).fail(function(){5>k?(k++,x()):($("#tramLoading1 img").velocity("stop"),$("#tramLoading1").toggle(!1),$("<p>",{html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#toTiefenbrunnenTile"))})};x();var C=0,z=function(){$.get("http://transport.opendata.ch/v1/connections?from=008591135&to=008591428",function(e){_($(e)),$("#tramLoading2 img").velocity("stop"),$("#tramLoading2").toggle(!1)}).fail(function(){5>C?(C++,z()):($("#tramLoading2 img").velocity("stop"),$("#tramLoading2").toggle(!1),$("<p>",{html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#toWerdhoelzliTile"))})};z();var I=0,H=function(){$.get("http://transport.opendata.ch/v1/connections?from=008591135&to=008580522",function(e){Z($(e)),$("#tramLoading3 img").velocity("stop"),$("#tramLoading3").toggle(!1)}).fail(function(){5>I?(I++,H()):($("#tramLoading3 img").velocity("stop"),$("#tramLoading3").toggle(!1),$("<p>",{html:"Daten konnten nicht geladen werden. Bitte Seite neu laden."}).appendTo("#toEscherWyssPlatzTile"))})};H();var E=function(e){$.each(e.get(0).connections,function(t){var n=new Date(1e3*e.get(0).connections[t].from.departureTimestamp),o="0"+n.getHours(),a="0"+n.getMinutes(),i=o.substr(o.length-2)+":"+a.substr(a.length-2),d=e.get(0).connections[t].products[0];$("#toAltstetten"+t+" td:nth-child(2)").html(d),$("#toAltstetten"+t+" td:nth-child(3)").html("4"),$("#toAltstetten"+t+" td:nth-child(1)").html(i),$("#toAltstettenTile tr").css({"border-bottom":"1px solid #d4d4cc"})})},W=function(e){$.each(e.get(0).connections,function(t){var n=new Date(1e3*e.get(0).connections[t].from.departureTimestamp),o="0"+n.getHours(),a="0"+n.getMinutes(),i=o.substr(o.length-2)+":"+a.substr(a.length-2),d=e.get(0).connections[t].products[0];$("#toTiefenbrunnen"+t+" td:nth-child(2)").html(d),$("#toTiefenbrunnen"+t+" td:nth-child(3)").html("4"),$("#toTiefenbrunnen"+t+" td:nth-child(1)").html(i),$("#toTiefenbrunnenTile tr").css({"border-bottom":"1px solid #d4d4cc"})})},_=function(e){$.each(e.get(0).connections,function(t){var n=new Date(1e3*e.get(0).connections[t].from.departureTimestamp),o="0"+n.getHours(),a="0"+n.getMinutes(),i=o.substr(o.length-2)+":"+a.substr(a.length-2),d=e.get(0).connections[t].products[0];$("#toWerdhoelzli"+t+" td:nth-child(2)").html(d),$("#toWerdhoelzli"+t+" td:nth-child(3)").html("17"),$("#toWerdhoelzli"+t+" td:nth-child(1)").html(i),$("#toWerdhoelzliTile tr").css({"border-bottom":"1px solid #d4d4cc"})})},Z=function(e){$.each(e.get(0).connections,function(t){var n=new Date(1e3*e.get(0).connections[t].from.departureTimestamp),o="0"+n.getHours(),a="0"+n.getMinutes(),i=o.substr(o.length-2)+":"+a.substr(a.length-2),d=e.get(0).connections[t].products[0];$("#toEscherWyssPlatz"+t+" td:nth-child(2)").html(d),$("#toEscherWyssPlatz"+t+" td:nth-child(3)").html("17"),$("#toEscherWyssPlatz"+t+" td:nth-child(1)").html(i),$("#toEscherWyssPlatzTile tr").css({"border-bottom":"1px solid #d4d4cc"})})},B=$("#hamburger");$("#menu").click(function(){B.hasClass("dropdown")?(B.velocity({duration:250,rotateZ:"0deg"}),$("div.header").velocity({height:"4em",duration:250})):(B.velocity({duration:250,rotateZ:"180deg"}),$("div.header").velocity({height:"14em",duration:250})),B.toggleClass("dropdown")}),B.click(function(){B.hasClass("dropdown")?(B.velocity({duration:250,rotateZ:"0deg"}),$("div.header").velocity({height:"4em",duration:250})):(B.velocity({duration:250,rotateZ:"180deg"}),$("div.header").velocity({height:"14em",duration:250})),B.toggleClass("dropdown")}),$("#menuMensa").click(function(){$("div.header").velocity({height:"4em",duration:250}),n.swipeTo(0,400),s.html("mensa"),B.velocity({duration:250,rotateZ:"0deg"}),B.toggleClass("dropdown")}),$("#menuAgenda").click(function(){$("div.header").velocity({height:"4em",duration:250}),n.swipeTo(1,400),s.html("agenda"),B.velocity({duration:250,rotateZ:"0deg"}),B.toggleClass("dropdown")}),$("#menuTram").click(function(){$("div.header").velocity({height:"4em",duration:250}),n.swipeTo(2,400),s.html("tram"),B.velocity({duration:250,rotateZ:"0deg"}),B.toggleClass("dropdown")}),$("#refresh").click(function(){location.reload(!0),$("#refresh").velocity({duration:5e3,rotateZ:"1800deg"},{loop:!0})}),$("#mensaLoadingTile").click(function(){location.reload(!0)}),$("#agendaLoadingTile").click(function(){location.reload(!0)}),$("#info").click(function(){$("#popupInfo").toggleClass("popup"),$("#popupBg").velocity("fadeIn",{duration:400})}),$("#popupInfo").click(function(){$("#popupInfo").toggleClass("popup"),$("#popupBg").velocity("fadeOut",{duration:400})}),$("#popupEvent").click(function(){$("#popupEvent").toggleClass("popup"),$("#popupBg").velocity("fadeOut",{duration:400}),$("#eventContainer").empty()}),$(window).on("navigate",function(e,t){var n=t.state.direction;"back"==n&&$("#popupInfo").hasClass("popup")&&(e.preventDefault(),$("#popupInfo").toggleClass("popup"),$("#popupBg").velocity("fadeOut",{duration:400}))})});