var mapModule=angular.module("mapModule",[]).controller("MapController",["$scope","$rootScope","$routeParams","MapService","RoomSearchService","ControlBarService","$window","$timeout",function(o,i,t,n,e,s,a,r){o.init=function(){o.data={},o.data.svgUrl="build/maps/toni_map_floor_"+t.floor+".svg?v=1",n.currentFloor=t.floor,o.data.currentFloor=n.currentFloor,o.data.nextFloorIsHigher=n.nextFloorIsHigher,o.data.hideRoomLabels=!0,o.data.hideIconsAll=!0,o.data.hideIconsFood=n.hideIconsFood,o.data.hideIconsCopy=n.hideIconsCopy,o.data.hideIconsSurf=n.hideIconsSurf,o.data.hideIconsToilets=n.hideIconsToilets,o.data.hideIconsElevators=n.hideIconsElevators,o.data.hideIconsRecycle=n.hideIconsRecycle,o.data.zoom=2.5,o.data.tempScale=.5,i.$broadcast("mapIsInitialized")},o.initSvg=function(){o.svg=$("#map-pane-"+o.data.currentFloor+" svg"),o.svg.panzoom({increment:.5,maxScale:15,minScale:.5,onPan:o.mapMoved,onZoom:o.mapZoomed}),o.snapSvg=Snap("#map-pane-"+o.data.currentFloor+" svg"),Snap.load("build/pathmeshes/toni_pathmesh_"+o.data.currentFloor+".svg?v=1",function(i){o.snapSvg.append(i),o.markRoomShape(),o.showMyPosition(),o.paintRoute(),n.isMovingToHighlightRoom?r(function(){o.moveToRoomShape()},200):(o.svg.panzoom("zoom",.5),o.svg.panzoom("pan",-225,-320)),n.isMovingToMyPosition&&r(function(){o.moveToMyPosition()},200)})},o.markRoomShape=function(){if(void 0!==n.roomToHighlight&&null!==n.roomToHighlight){var o=Snap('[id="'+n.roomToHighlight.planRoomNr+'"]');null!=o&&o.addClass("highlighted")}},o.unmarkRoomShape=function(){if(void 0!==n.roomToHighlight&&null!==n.roomToHighlight){var o=$('[id="'+n.roomToHighlight.planRoomNr+'"]'),o=Snap('[id="'+n.roomToHighlight.planRoomNr+'"]');null!=o&&(o.removeClass("highlighted"),n.roomToHighlight=null)}},o.moveToRoomShape=function(){void 0!==n.roomToHighlight&&null!==n.roomToHighlight&&r(function(){o.svg.panzoom("zoom",1.5,{animate:!1});var i=$('[id="'+n.roomToHighlight.planRoomNr+'"]');if(i.length>0){var t=i.position(),e={};e.clientX=a.innerWidth/2-(t.left+i.get(0).getBoundingClientRect().width/2),e.clientY=a.innerHeight/2-(t.top+i.get(0).getBoundingClientRect().height/2),o.svg.panzoom("pan",e.clientX,e.clientY,{relative:!0,animate:!0})}},100),n.isMovingToHighlightRoom=!1},o.mapMoved=function(){n.showMyPositionAfterFloorSwitch||s.deactivatePositioningButton()},o.mapZoomed=function(i,t,e){n.showMyPositionAfterFloorSwitch||s.deactivatePositioningButton(),Math.abs(e-o.data.tempScale)>.2&&(r(function(){o.data.hideRoomLabels=1>e,o.data.hideIconsAll=.6>e},100),o.data.tempScale=e)},o.showMyPosition=function(){if(void 0!=n.myPosition&&n.myPosition.floor==n.currentFloor)if(console.log("SHOWMYPOS"),void 0===o.myPositionCircle||null===o.myPositionCircle){o.myPositionCircle=o.snapSvg.group();var i=o.myPositionCircle.circle(n.myPosition.x,n.myPosition.y,40),t=o.myPositionCircle.circle(n.myPosition.x,n.myPosition.y,10),e=o.myPositionCircle.circle(n.myPosition.x,n.myPosition.y,5);o.myPositionCircle.attr({id:"my-position-circle"}),i.addClass("surround"),t.addClass("animated infinite my-pos-pulse"),e.addClass("animated infinite my-pos-pulse delay")}else o.myPositionCircle.removeClass("hide")},o.hideMyPosition=function(){void 0!==o.myPositionCircle&&null!==o.myPositionCircle&&o.myPositionCircle.addClass("hide")},o.moveToMyPosition=function(){console.log("MOVE TO POSITION"),void 0!==n.myPosition&&null!==n.myPosition&&void 0!=o.myPositionCircle&&null!=o.myPositionCircle&&r(function(){o.svg.panzoom("zoom",1.5,{animate:!1});var i=$("#my-position-circle .surround");if(console.log(i),i.length>0){var t=i.position(),n={};n.clientX=a.innerWidth/2-(t.left+i.get(0).getBoundingClientRect().width/2),n.clientY=a.innerHeight/2-(t.top+i.get(0).getBoundingClientRect().height/2),console.log("TOPOX"+n.clientX),console.log("TOPOY"+n.clientY),o.svg.panzoom("pan",n.clientX,n.clientY,{relative:!0,animate:!0})}},100),n.isMovingToMyPosition=!1},o.paintRoute=function(){if(void 0!==o.lineToRoom&&null!==o.lineToRoom&&o.lineToRoom.remove(),void 0!==o.lineToPos&&null!==o.lineToPos&&o.lineToPos.remove(),console.log("TRY start display route"),void 0!==n.route&&null!==n.route){console.log("start display route");var i=o.snapSvg.selectAll(".path-line"),t=o.snapSvg.polygon([0,4,4,4,2,0,0,4]).addClass("arrow-marker").transform("r90"),e=o.snapSvg.polygon([0,4,4,4,2,0,0,4]).addClass("arrow-marker arrow-marker-inv").transform("r270"),s=t.marker(0,0,4,4,0,2),a=e.marker(0,0,4,4,0,2),r=null;$.each(i,function(o,i){i.removeClass("active")});for(var l=0;l<n.route.length;l++)null!=r&&$.each(i,function(o,i){var t=i.attr("id"),e="l-"+r+"-to-"+n.route[l],c="l-"+n.route[l]+"-to-"+r;(t===e||t===c)&&(i.addClass("active"),t===e?i.attr({markerStart:s}):i.attr({markerStart:a}))}),r=n.route[l]}},o.$watch("data.zoom",function(){void 0!==o.svg&&o.svg.panzoom("zoom",.015*o.data.zoom+.5)}),o.$on("showMyPosition",function(){o.showMyPosition(),o.moveToMyPosition()}),o.$on("hightlightRoomOnSameFloor",function(){o.markRoomShape(),o.moveToRoomShape()}),o.$on("unhightlightRoom",function(){o.unmarkRoomShape()}),o.$on("mapTransition",function(){o.data.nextFloorIsHigher=n.nextFloorIsHigher}),o.$on("routeCalculated",function(){o.paintRoute()}),o.$on("hideIconsChanged",function(){o.data.hideIconsFood=n.hideIconsFood,o.data.hideIconsCopy=n.hideIconsCopy,o.data.hideIconsSurf=n.hideIconsSurf,o.data.hideIconsToilets=n.hideIconsToilets,o.data.hideIconsElevators=n.hideIconsElevators,o.data.hideIconsRecycle=n.hideIconsRecycle}),o.init()}]).service("MapService",["$rootScope","$location","RoomSearchService","$timeout","$window",function(o,i,t,n){var e=this;this.highlightRoom=function(i){this.dehighlightRoom(),this.isMovingToHighlightRoom=!0,this.roomToHighlight=i,i.floor!=this.currentFloor?n(function(){e.switchFloor(i.floor)},300):n(function(){o.$broadcast("hightlightRoomOnSameFloor")},300)},this.dehighlightRoom=function(){o.$broadcast("unhightlightRoom")},this.switchFloor=function(t){this.currentFloor!=t&&(this.nextFloorIsHigher=t>this.currentFloor,o.$broadcast("mapTransition"),i.path("/map/"+t))},this.showMyPosition=function(){var i={};i.floor=3,i.x=145,i.y=861,this.myPosition=i,console.log("start showing pos"),console.log(this.myPosition),this.isMovingToMyPosition=!0,this.myPosition.floor!=this.currentFloor?(console.log("switch a floor for pos disp"),this.showMyPositionAfterFloorSwitch=!0,this.switchFloor(this.myPosition.floor)):(console.log("Pos disp on same floor"),o.$broadcast("showMyPosition"))},this.setHideIconsFood=function(i){this.hideIconsFood=i,o.$broadcast("hideIconsChanged")},this.setHideIconsCopy=function(i){this.hideIconsCopy=i,o.$broadcast("hideIconsChanged")},this.setHideIconsSurf=function(i){this.hideIconsSurf=i,o.$broadcast("hideIconsChanged")},this.setHideIconsToilets=function(i){this.hideIconsToilets=i,o.$broadcast("hideIconsChanged")},this.setHideIconsElevators=function(i){this.hideIconsElevators=i,o.$broadcast("hideIconsChanged")},this.setHideIconsRecycle=function(i){this.hideIconsRecycle=i,o.$broadcast("hideIconsChanged")},this.findRoute=function(i){this.showMyPosition(),console.log("start getting route");var i="3-1745-831",t=this.getRouteEndPoint();$.get("http://exohosting.ch/tonipathfinder/index.php?start="+i+"&end="+t,function(i){e.route=i.toString().split(","),o.$broadcast("routeCalculated"),console.log(e.route)}).fail(function(){console.log("ERROR GETTING ROUTE PATH")})},this.getRouteEndPoint=function(){console.log("GET END");var o=Snap('[id="'+this.roomToHighlight.planRoomNr+'"]');if(console.log(o),null!=o){var i=o.getBBox().cx,t=o.getBBox().cy,n=$(".path-point"),e=new Array;$.each(n,function(o,n){var s={};s.pointId=n.getAttribute("id");var a=i-n.getAttribute("cx"),r=t-n.getAttribute("cy");s.distance=Math.sqrt(a*a+r*r),e.push(s)}),e.sort(this.compareDistances)}var s=e[0].pointId.substr(2,e[0].pointId.length);return console.log("ENDP="+s),s},this.compareDistances=function(o,i){return o.distance<i.distance?-1:o.distance>i.distance?1:0}}]).directive("tmMap",function(){return{restrict:"E",template:'<div ng-include="data.svgUrl" include-replace onload="initSvg()"></div>',link:function(){}}});